<html lang="en">

<head>
    <meta charset="utf-8">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <meta content="html 5 template" name="description">
    <meta content="tonytemplates.com" name="author">
    <link href="favicon.ico" rel="icon">
    <title>订单信息</title>
    <!-- Bootstrap core CSS -->
    <link href="../css/plugins/bootstrap.min.css" rel="stylesheet">
    <link href="../css/plugins/bootstrap-submenu.css" rel="stylesheet">
    <link href="../css/plugins/animate.min.css" rel="stylesheet">
    <link href="../css/plugins/nivo-slider.css" rel="stylesheet">
    <link href="../css/plugins/slick.css" rel="stylesheet">
    <link href="../css/plugins/magnific-popup.css" rel="stylesheet">
    <link href="../css/custom.css" rel="stylesheet">
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icon Font-->
    <link href="../iconfont/style.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link
            href="https://fonts.googleapis.com/css?family=Roboto:100,100i,300,400,500,700,900"
            rel="stylesheet">
    <!-- Google map -->
    <!---<script type="text/javascript" src="http://ditu.google.cn/maps/api/js"></script>--->
</head>

<body class="home">
<!-- Loader -->
<div class="loader-on" id="loader-wrapper">
    <div id="loader">
        <div class="loader">
            <div class="bolt one">
                <div class="other"></div>
            </div>
            <div class="bolt two">
                <div class="other"></div>
            </div>
            <div class="bolt three">
                <div class="other"></div>
            </div>
            加载中
        </div>
    </div>
</div>
<!-- //Loader -->
<!-- Header -->
<header class="page-header">
    <!-- Fixed navbar -->
    <nav class="navbar" id="slide-nav">
        <div class="container">
            <div class="navbar-header">
                <div class="header-top">
                    <div class="row">
                        <div class="col-sm-4">
                            <div class="social-links">
                                <!--									<ul>-->
                                <!--										<li><a class="icon icon-twitter" href="#"></a></li>-->
                                <!--										<li><a class="icon icon-facebook" href="#"></a></li>-->
                                <!--										<li><a class="icon icon-instagram" href="#"></a></li>-->
                                <!--									</ul>-->
                            </div>
                        </div>
                        <div class="col-sm-4 text-center">
                            <div class="logo">
                                <a href="index.html"><img alt="Logo"
                                                          src="../images/new/logo.png"> </a>
                            </div>
                        </div>
                        <div class="col-sm-4">
                            <div class="phone">
                                <div class="number">
                                    <i class="icon icon-telephone"></i><span>123456789</span>
                                </div>
                                <div class="under-number">惠想出行 尊享体验</div>
                            </div>
                        </div>
                    </div>
                </div>
                <button class="navbar-toggle" type="button">
                    <i class="icon icon-interface icon-menu"></i><i
                        class="icon icon-cancel"></i>
                </button>
            </div>
            <div data-animations="fadeIn" data-hover="dropdown" id="slidemenu">
                <ul class="nav navbar-nav">
                    <li><a href="index.html"><span class="electric-btn"><span class="text">首页</span></span></a></li>
                    <li><a href="prices.html"><span class="electric-btn"><span class="text">订票</span></span></a></li>
                    <li class="active"><a href="orderForm.html"><span class="electric-btn"><span
                            class="text">订单信息</span></span></a></li>
                    <li><a href="contact.html"><span class="electric-btn"><span class="text">个人信息</span></span></a></li>
                    <li onclick="returnIndex()"><a href="login.html"><span class="electric-btn"><span
                            class="text">注销</span></span></a></li>
                </ul>
            </div>
        </div>
    </nav>
</header>
<!-- // Header -->
<!-- Content  -->
<div id="page-content">
    <!-- Breadcrumbs Block -->
    <div class="container">
        <div class="breadcrumbs">
            <ul class="breadcrumb">
                <li><a href="index.html">首页</a></li>
                <li class="active">订单信息</li>
            </ul>
        </div>
    </div>
    <!-- //Breadcrumbs Block -->
    <!-- Block -->
    <div class="block">
        <div class="container">
            <h1 class="text-center">
                订单 <b>信息</b>
            </h1>
            <p class="font24 text-center">点击订单的查看订单进行退票或者改签操作</p>
            <div class="table-wrapper">
                <table class="table price-table" id="orderTable" id="orderTable">
                    <thead>
                    <tr class="table-header">
                        <th>乘车人</th>
                        <th>始发地</th>
                        <th>出发时间</th>
                        <th>目的地</th>
                        <th>到达时间</th>
                        <th>班次号</th>
                        <th>价格</th>
                        <th>座位</th>
                        <th>订单状态</th>
                        <th>操作</th>
                    </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
    <!-- //Block -->
</div>
<!-- // Content  -->

<div class="block">
    <h1 class="text-center decor color">
        订单 <b>详细信息</b>
    </h1>
    <div class="divider"></div>
</div>

<div class="block">
    <div class="container">
        <div class="row">
            <div class="col-sm-5 col-md-3">
                <div class="address">
                    <div class="address-block">
                        <i class="icon icon-map-marker"></i>
                        <h6 class="text-uppercase">公司地址:</h6>
                        Hangzhou Normal University <br>
                    </div>
                    <div class="address-block">
                        <i class="icon icon-telephone"></i>
                        <h6 class="text-uppercase">联系客服:</h6>
                        13011111111
                    </div>
                    <div class="divider-sm"></div>
                    <h6>我有问题？</h6>
                    <p>
                        <a href="#">123456789@123.com</a> <br> <a href="#">www.stildream.xyz</a>
                    </p>
                </div>
                <div class="divider"></div>
                <div class="social-links">
                    <!--							<ul>-->
                    <!--								<li><a class="icon icon-twitter" href="#"></a></li>-->
                    <!--								<li><a class="icon icon-facebook" href="#"></a></li>-->
                    <!--								<li><a class="icon icon-google-plus" href="#"></a></li>-->
                    <!--								<li><a class="icon icon-linkedin" href="#"></a></li>-->
                    <!--								<li><a class="icon icon-instagram" href="#"></a></li>-->
                    <!--							</ul>-->
                </div>
            </div>
            <div class="col-sm-1 visible-lg"></div>
            <div class="col-sm-7 col-md-8">
                <form class="contact-form"
                >
                    <div hidden id="info">
                        <p>请您尽快完成支付，否则订单会自动取消！支付剩余时间：<span id="time"></span></p>
                    </div>
                    <div class="inputs-col">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="input-wrapper">
                                    <label>姓名 <span class="required"></span></label> <input
                                        class="input-custom input-full" disabled id="trueName" name="trueName"
                                        type="text">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="input-wrapper">
                                    <label>电话</label> <input class="input-custom input-full"
                                                             disabled id="phone" name="phone"
                                                             type="text">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="input-wrapper">
                                    <label>身份证号 <span class="required"></span></label> <input
                                        class="input-custom input-full" disabled id="identity" name="identity"
                                        type="text">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="input-wrapper">
                                    <label>车次号</label> <input class="input-custom input-full"
                                                              disabled id="carNum" name="carNum"
                                                              type="text">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="input-wrapper">
                                    <label>始发地 <span class="required"></span></label> <input
                                        class="input-custom input-full" disabled id="orginLocation"
                                        name="orginLocation" type="text">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="input-wrapper">
                                    <label>目的地</label> <input class="input-custom input-full"
                                                              disabled id="destinationLocation"
                                                              name="destinationLocation" type="text">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="input-wrapper">
                                    <label>出发时间 <span class="required"></span></label> <input
                                        class="input-custom input-full" disabled id="startTime" name="startTime"
                                        type="text">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="input-wrapper">
                                    <label>到达时间</label> <input class="input-custom input-full"
                                                               disabled id="reachTime"
                                                               name="reachTime" type="text">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="input-wrapper">
                                    <label>价格<span class="required"></span></label> <input
                                        class="input-custom input-full" disabled id="ticketPrice" name="ticketPrice"
                                        type="text">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="input-wrapper">
                                    <label>座位<span class="required"></span></label>
                                    <select class="select-custom" id="seat">
                                        <option value="1">无座</option>
                                        <option value="2">一等座</option>
                                        <option value="3">二等座</option>
                                        <option value="4">商务座</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="input-wrapper"><input
                                        class="input-custom input-full" hidden id="orderId" type="text">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="input-wrapper"><input
                                        class="input-custom input-full" hidden id="changeTimes" type="text">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="input-wrapper"><input
                                        class="input-custom input-full" hidden id="tt" type="text">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="btn btn-border" id="buy" onclick="buy()">
                        <i class="icon icon-lightning"></i><span>支付</span>
                    </div>
                    <div class="btn btn-border" id="change" onclick="change()">
                        <i class="icon icon-lightning"></i><span>改签</span>
                    </div>
                    <div class="btn btn-border" onclick="refund1()">
                        <i class="icon icon-lightning"></i><span>退票</span>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="block">
    <h1 class="text-center decor color">
        改签 <b>可供选择的车次</b>
    </h1>
    <div class="divider"></div>
</div>
<!-- //Block -->
<!-- Block -->
<div class="block">
    <div class="container">
        <div class="table-wrapper">
            <table class="table price-table" id="changeTable">
                <thead>
                <tr class="table-header">
                    <th>始发地</th>
                    <th>出发时间</th>
                    <th>目的地</th>
                    <th>到达时间</th>
                    <th>班次号</th>
                    <th>价格</th>
                    <th>数量</th>
                    <th>操作</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Footer -->
<div class="page-footer">
    <div class="back-to-top hidden-xs">
        <a href="#top"><span class="icon icon-lightning"></span></a>
    </div>
    <div class="footer-top">
        <div class="container">
            <div class="row">
                <div class="col-sm-4">24小时在线服务</div>
                <div class="col-sm-1 hidden-xs">&nbsp;</div>
                <div class="col-sm-3">免费咨询</div>
                <div class="col-sm-1 hidden-xs">&nbsp;</div>
                <div class="col-sm-3">123456789</div>
            </div>
        </div>
    </div>
    <div class="container">
        <div class="row footer-row">
            <div class="col-sm-3 col-lg-3">
                <div class="logo">
                    <a href="index.html"><img alt="Logo"
                                              src="../images/new/logo.png"></a>
                </div>
                <div class="hidden-xs">
                    <div class="copyright">
                        © 2020 12307 <br> All Rights Reserved
                    </div>
                    <!--						<div class="social-links">-->
                    <!--							<ul>-->
                    <!--								<li><a class="icon icon-twitter" href="#"></a></li>-->
                    <!--								<li><a class="icon icon-facebook" href="#"></a></li>-->
                    <!--								<li><a class="icon icon-instagram" href="#"></a></li>-->
                    <!--							</ul>-->
                    <!--						</div>-->
                </div>
            </div>
            <div class="col-sm-4">
                <ul class="contact-list">
                    <li><span class="list-label"><b>联</b>系电话: </span> <span
                            class="text">123456789</span></li>
                    <li><span class="list-label"><b>电</b>子邮件:</span> <span
                            class="text"><a href="mailto:info@yourdomain.com">info@12307.com</a></span></li>
                    <li><span class="list-label"><b>地</b>址:</span> <span
                            class="text">Hangzhou Normal University<br>
						</span></li>
                    <li>Mon-Fri <b>08:00</b> AM - <b>10:00</b> PM, Sat-Sun
                    </li>
                </ul>
            </div>
            <div class="col-sm-5">
                <div id="footer-map"></div>
            </div>
            <div class="visible-xs text-center">
                <div class="copyright">
                    Copyright &copy; 2020 12307 All rights reserved.More
                </div>
                <!--					<div class="social-links">-->
                <!--						<ul>-->
                <!--							<li><a class="icon icon-twitter" href="#"></a></li>-->
                <!--							<li><a class="icon icon-facebook" href="#"></a></li>-->
                <!--							<li><a class="icon icon-instagram" href="#"></a></li>-->
                <!--						</ul>-->
                <!--					</div>-->
            </div>
        </div>
    </div>
</div>

<!-- //Footer -->

<script src="../js/jquery.js"></script>
<script src="../js/plugins/bootstrap.min.js"></script>
<script src="../js/plugins/slick.min.js"></script>
<script src="../js/plugins/jquery.form.js"></script>
<script src="../js/plugins/jquery.validate.min.js"></script>
<script src="../js/plugins/bootbox.min.js"></script>
<script src="../js/plugins/bootbox.locales.min.js"></script>
<script src="../js/custom.js"></script>
<script language="JavaScript">
    fillerIn();
    var json = [];
    var storage = window.localStorage;
    var username = storage["username"];
    // ajax传递数据
    var json = {
        "username": username
    }; // 这里的orderId是指订单id,tripsId是指新车票的id
    // ajax提交数据
    $.ajax({
        type: 'POST',
        url: base_url + '/getorder',
        data: JSON.stringify(json),
        contentType: 'application/json;charset=utf-8',
        dataType: 'json',
        success: function (data) {
            if (data.stateCode === 200) {
                // 订单信息查询成功
                console.log("11");
                console.log(data.data);
                console.log("查询订单信息成功，呈现到订单信息的页面当中");
                //暂时的解决掉数据的参数传递问题
                window.localStorage.setItem("orderItem", JSON.stringify(data.data));
                json = JSON.stringify(data.data);
                // $("#orderTable").html("");
                $("#orderTable tbody").html('');


                for (var i = 0; i < data.data.length; i++) {
                    switch (data.data[i].seat) {
                        case 1:
                            data.data[i].seat = "无座";
                            break;
                        case 2:
                            data.data[i].seat = "一等座";
                            break;
                        case 3:
                            data.data[i].seat = "二等座";
                            break;
                        case 4:
                            data.data[i].seat = "商务座";
                            break;
                    }
                    var tr;
                    tr = '<td>' + data.data[i].trueName + '</td>' + '<td>'
                        + data.data[i].orginLocation + '</td>' + '<td>'
                        + data.data[i].startTime + '</td>' + '<td>'
                        + data.data[i].destinationLocation + '</td>'
                        + '<td>' + data.data[i].reachTime + '</td>'
                        + '<td>' + data.data[i].carNum + '</td>' + '<td>'
                        + data.data[i].ticketPrice + '</td>' + '<td>'
                        + data.data[i].seat + '</td>' + '<td>'
                        + data.data[i].status + '</td>' + '<td>'
                        + '<button onclick="orderDetail(' + i + ')' + '">查看</button>'
                        + '</td>';
                    $("#orderTable tbody").append('<tr>' + tr + '</tr>');
                }
            } else
                // 查询失败,错误信息在data.msg里面（未填写个人信息，请完善个人信息）
                alert("错误信息：" + data.msg)

        }
    });

    function buy() {
        if ($("#trueName").val() == "")
            return;
        if ($("#buy").attr("disabled") != null)
            return;
        var json = {
            "carNum": $("#carNum").val(),
            "startTime": $("#startTime").val(),
            "orderId": Number.parseInt($("#orderId").val())
        };
        bootbox.confirm({
            size: "small",
            message: "是否支付订单",
            buttons: {
                confirm: {
                    label: '确认',
                    className: ''
                },
                cancel: {
                    label: '取消',
                    className: ''
                }
            },
            callback(result) {
                if (result) {
                    $.ajax({
                        type: 'POST',
                        url: base_url + '/paymoney',
                        data: JSON.stringify(json),
                        contentType: 'application/json;charset=utf-8',
                        dataType: 'json',
                        success: function (data) {
                            if (data.stateCode == "200") {
                                // 个人信息查询成功
                                console.log("支付成功");
                                window.location.href = 'orderForm.html';
                            } else
                                // 查询失败,错误信息在data.msg里面（未填写个人信息，请完善个人信息）
                                alert("错误信息：" + data.msg)
                        }
                    })
                } else {

                }
            }
        })
    }


    function refund1() {
        if ($("#trueName").val() == "")
            return;

        console.log("实现用户退票的操作");
        //获取身份证号，车次号，出发时间，始发地
        // var idCardNum = $("#identity").val();
        // var carNum = $("#carNum").val();
        var carNum = $("#carNum").val();
        var startTime = $("#startTime").val();
        var reachTime = $("#reachTime").val();
        var json = {
            "username": window.localStorage.getItem("username"),
            "carNum": carNum,
            "startTime": startTime,
            "reachTime": reachTime
        };
        // ajax提交数据
        $.ajax({
            type: 'POST',
            url: base_url + '/ticketrefund',
            data: JSON.stringify(json),
            contentType: 'application/json;charset=utf-8',
            dataType: 'json',
            success: function (data) {
                if (data.stateCode == "200") {
                    // 个人信息查询成功
                    console.log("退票成功，呈现到个人信息的页面当中");
                    window.location.href = 'orderForm.html';
                } else
                    // 查询失败,错误信息在data.msg里面（未填写个人信息，请完善个人信息）
                    alert("错误信息：" + data.msg)
            }
        })
    }

    var timeobj;

    function clock() {
        let residue = new Date().getTime() - new Date($("#tt").val()).getTime();
        if (residue >= 1800000) {
            $("#info span").html("订单已自动取消");
            window.clearTimeout(timeobj);
            $("#buy span").html("已取消");
            $("#buy").attr("disabled", "disabled")
        } else {
            residue = 1800000 - residue;
            var minute = Math.floor(residue / (1000 * 60)) % 60;
            var second = Math.floor(residue / 1000) % 60;
            $("#info span").html(`${minute}分钟:${second}秒`);
            $("#buy span").html("支付");
            $("#buy").removeAttrs("disabled")
        }
    }

    function orderDetail(i) {
        // 在当前界面当中填充好详细信息然后再实现改签等的操作
        $("#trueName").val('');
        $("#phone").val('');
        $("#identity").val('');
        $("#carNum").val('');
        $("#orginLocation").val('');
        $("#destinationLocation").val('');
        $("#startTime").val('');
        $("#reachTime").val('');
        $("#ticketPrice").val('');
        $("#orderId").val('');
        $("#changeTimes").val('');
        $("#seat").val('');
        var data = JSON.parse(json);
        console.log(data);
        console.log(i);
        data = data[i];
        console.log("用户点击某个订单呈现出详细信息");
        $("#trueName").val(data.trueName);
        $("#phone").val(data.phoneNum);
        $("#identity").val(data.idCardNum);
        $("#carNum").val(data.carNum);
        $("#orginLocation").val(data.orginLocation);
        $("#destinationLocation").val(data.destinationLocation);
        $("#startTime").val(data.startTime);
        $("#reachTime").val(data.reachTime);
        $("#ticketPrice").val(data.ticketPrice);
        $("#orderId").val(data.id);
        $("#changeTimes").val(data.changeTimes);
        $("#seat").val(data.seat);
        $(".btn").hide();
        $("#tt").val(data.orderTime);
        $("#seat").attr("disabled", "disabled");
        $("#changeTable tbody").html('');
        $("#info").hide();
        window.clearTimeout(timeobj);
        console.log(data.status);
        if (data.status == "未支付") {
            $("#buy").show();
            $("#info").show();
            timeobj = setInterval("clock()", 1000)
        } else if (data.status == "已退票") {
            $(".btn").hide()
        } else {
            $("#change").show();
            $("#change").next().show()
        }

    }

    function changeTrip(tripId) {
        if ($("#changeTimes").val() == 1) {
            alert("仅允许改签1次");
            return;
        }

        $.ajax({
            type: 'POST',
            url: base_url + '/changeorder',
            data: JSON.stringify({
                orderId: Number.parseInt($("#orderId").val()),
                tripsId: Number.parseInt(tripId),
                seat: Number.parseInt($("#seat").val())
            }),
            contentType: 'application/json;charset=utf-8',
            dataType: 'json',
            success: function (data) {
                if (data.stateCode == "200") {
                    // 个人信息查询成功
                    console.log("改签成功，呈现到个人信息的页面当中");
                    window.location.href = 'orderForm.html';
                } else
                    // 查询失败,错误信息在data.msg里面（未填写个人信息，请完善个人信息）
                    alert("错误信息：" + data.msg)
            }
        })
    }
</script>


</body>
</html>
